# Настройка GitLab для хранения "шар"

Этот документ описывает, как настроить GitLab Repository API для хранения "шар" (shares) вместо GitHub Gists.

## Шаг 1: Создание проекта в GitLab

1. Войдите в GitLab (gitlab.com или ваш self-hosted GitLab)
2. Создайте новый проект, например `drawdb-shares`
   - Рекомендуется установить уровень доступа: **private** или **internal**
   - Это обеспечит безопасность - только сервер будет иметь доступ через токен
3. Запишите **Project ID** проекта (можно найти в настройках проекта или в URL)

## Шаг 2: Создание токена доступа

### Вариант A: Personal Access Token

1. Перейдите в **Settings** → **Access Tokens** (или **User Settings** → **Access Tokens**)
2. Создайте новый токен с правами:
   - `read_repository` - для чтения файлов и коммитов
   - `write_repository` - для создания/обновления/удаления файлов
3. Скопируйте токен (он показывается только один раз!)

### Вариант B: Project Access Token

1. Перейдите в проект → **Settings** → **Access Tokens**
2. Создайте Project Access Token с правами:
   - `read_repository`
   - `write_repository`
3. Скопируйте токен

## Шаг 3: Настройка переменных окружения

Добавьте следующие переменные в ваш `.env` файл:

```env
# GitLab Configuration
GITLAB_BASE_URL=https://gitlab.com
# Для self-hosted GitLab используйте:
# GITLAB_BASE_URL=https://gitlab.yourcompany.local

GITLAB_TOKEN=your_gitlab_token_here
GITLAB_PROJECT_ID=12345678
GITLAB_REF=main
SHARES_PATH_PREFIX=shares/
```

### Описание переменных:

- `GITLAB_BASE_URL` - URL вашего GitLab инстанса (по умолчанию: `https://gitlab.com`)
- `GITLAB_TOKEN` - Personal Access Token или Project Access Token с правами `read_repository` и `write_repository`
- `GITLAB_PROJECT_ID` - Числовой ID проекта (можно найти в настройках проекта)
- `GITLAB_REF` - Название ветки (по умолчанию: `main`)
- `SHARES_PATH_PREFIX` - Префикс пути для файлов в репозитории (по умолчанию: `shares/`)

## Шаг 4: Проверка работы

После настройки переменных окружения, сервер автоматически будет использовать GitLab Repository API вместо GitHub Gists API.

### Как это работает:

1. **Создание "шары"**: 
   - Сервер генерирует UUID для `shareId`
   - Создаёт файл `shares/<shareId>.json` в репозитории через GitLab API
   - Возвращает клиенту `{ id: shareId }`

2. **Получение "шары"**:
   - Сервер читает файл `shares/<id>.json` из репозитория
   - Декодирует base64 контент и возвращает клиенту

3. **Обновление "шары"**:
   - Сервер обновляет файл через GitLab API
   - Каждое обновление создаёт новый коммит → появляется новая ревизия

4. **Удаление "шары"**:
   - Сервер удаляет файл через GitLab API
   - Создаётся коммит с удалением файла

5. **История ревизий**:
   - Сервер получает список коммитов по пути файла
   - Возвращает список версий с commit id, датой, сообщением

6. **Конкретная ревизия**:
   - Сервер получает файл на конкретном commit sha
   - Возвращает содержимое на ту дату

## Безопасность

⚠️ **Важные рекомендации:**

1. **Репозиторий должен быть private** - это предотвратит прямой доступ к файлам без авторизации
2. **Токен хранится только на сервере** - никогда не передавайте токен клиентам
3. **Используйте Project Access Token** - это ограничивает права токена только одним проектом
4. **Регулярно ротируйте токены** - обновляйте токены периодически для безопасности

## Миграция с GitHub Gists

Если у вас уже есть существующие ссылки на GitHub Gists, вы можете:

1. **Поддержать оба провайдера** - определить по префиксу ID, какой провайдер использовать
2. **Создать мигратор** - прочитать gist, записать в GitLab, вернуть новый ID
3. **Оставить старые ссылки** - отображать их как "устаревший формат"

## Troubleshooting

### Ошибка: "GITLAB_TOKEN is required"
- Убедитесь, что переменная `GITLAB_TOKEN` установлена в `.env` файле

### Ошибка: "GITLAB_PROJECT_ID is required"
- Убедитесь, что переменная `GITLAB_PROJECT_ID` установлена и содержит числовой ID проекта

### Ошибка: 401 Unauthorized
- Проверьте, что токен правильный и не истёк
- Убедитесь, что токен имеет права `read_repository` и `write_repository`

### Ошибка: 404 Not Found
- Проверьте, что `GITLAB_PROJECT_ID` правильный
- Убедитесь, что проект существует и токен имеет к нему доступ

### Ошибка: 403 Forbidden
- Проверьте права токена - должны быть `read_repository` и `write_repository`
- Убедитесь, что проект не заблокирован или не удалён

## API Endpoints

Сервер предоставляет те же эндпоинты, что и раньше (для совместимости с фронтендом):

- `POST /gists` - создать "шару"
- `GET /gists/:id` - получить "шару"
- `PATCH /gists/:id` - обновить "шару"
- `DELETE /gists/:id` - удалить "шару"
- `GET /gists/:id/commits` - получить список ревизий
- `GET /gists/:id/:sha` - получить конкретную ревизию
- `GET /gists/:id/file-versions/:file` - получить версии файла с изменениями

Фронтенд не требует изменений - все эндпоинты работают так же, как и раньше.
